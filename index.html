import React, { useMemo, useState, useEffect, useRef } from "react";

const seedResults = [
  {
    title: "[부산한정] NFC 비누비누 베이베 키링 · GLOCAL:HD",
    url: "https://glocal-hd.com/product/...",
    displayUrl: "glocal-hd.com/product/...r",
    snippet:
      "사하구 하단 문화의거리에서 열리는 프렌치 마르쉐 & 공연 축제입니다. 부산외국어대학교 글로컬 크리에이터 하단 팀이 함께하는 프로젝트로, 일정·프로그램·티켓·지도 정보를 한눈에 확인할 수 있습니다.",
    rating: 4.9,
    reviews: 1482,
  },
  {
    title: "하단 숙박/체험 로컬 여행 상품 리스트 · 하단.음숙.다.대.허브",
    url: "https://hadan-travelhub.co.kr",
    displayUrl: "hadan.umsuk.daedae.heobeo",
    snippet:
      "부산 사하구 하단 문화의거리 기반의 로컬 여행 상품 추천 목록입니다. K-인싸 투어, 1일 비누 만들기, 로컬 맛집 등 다양한 테마별 액티비티와 숙박 정보를 제공합니다.",
    rating: 4.6,
    reviews: 524,
  },
  {
    title: "부산 파리 마르쉐 · 공식 안내(일정·오시는 길)",
    url: "https://busan-parisfest.kr",
    displayUrl: "busan-parisfest.kr",
    snippet:
      "사하구 하단 문화의거리에서 열리는 프렌치 마르쉐 & 공연 축제입니다. 프랑스의 마르쉐와 카페 문화를 옮겨온 도시형 축제로, 디저트/치즈, 공연, 포토스팟을 즐길 수 있습니다. (일정: 2025. 12. 6(토) - 12. 7(일))",
    rating: 4.7,
    reviews: 861,
  },
  {
    title: "하단 재즈 나잇 · 공연 라인업 및 타임테이블",
    url: "https://hadanjazz.kr/lineup",
    displayUrl: "hadanjazz.kr",
    snippet:
      "하단역 일대에서 열리는 도심형 재즈 축제입니다. 국내외 재즈 아티스트, 게스트 세션 정보와 공연 시간표를 미리 만나보세요.",
    rating: 4.8,
    reviews: 1023,
  },
  {
    title: "다대포 선셋 포토워크 · 참가자 모집(하단 출발)",
    url: "https://www.dadaepo-sunset.com/walk",
    displayUrl: "dadaepo-sunset.com",
    snippet:
      "하단에서 출발해 다대포 해변 일몰 명소를 걷는 포토워크입니다. 촬영 포인트, 복장 가이드, 날씨 체크리스트를 참고해보세요.",
    rating: 4.5,
    reviews: 392,
  },
  {
    title: "로컬 베이커리 위크 in 하단 · 참가 매장 안내",
    url: "https://bakeryweek.kr/hadan",
    displayUrl: "bakeryweek.kr",
    snippet:
      "하단의 개성 있는 로컬 베이커리 20여 곳이 참여합니다. 시그니처 메뉴, 빵 굽는 시간, 스탬프 위치와 한정 굿즈 정보를 제공합니다.",
    rating: 4.6,
    reviews: 745,
  },
];


export default function GoogleStyleSearchPreview() {
  const [q, setQ] = useState("부산외국어대학교 글로컬크리에이터 하단");
  const [submitted, setSubmitted] = useState("부산외국어대학교 글로컬크리에이터 하단");
  
  // ⭐️ 1. useRef를 사용하여 DOM 엘리먼트와 지도 인스턴스를 직접 참조
  const mapElementRef = useRef(null);
  const mapInstanceRef = useRef(null); 

  const results = useMemo(() => {
    if (!submitted) return seedResults;
    const k = submitted.trim().toLowerCase();
    const tokens = k.split(' ').filter(Boolean);
    const filtered = seedResults.filter((r) => {
      if (tokens.length === 0) return true;
      const title = r.title.toLowerCase();
      const snip = r.snippet.toLowerCase();
      return tokens.some((t) => title.includes(t) || snip.includes(t));
    });
    return filtered.length ? filtered : seedResults;
  }, [submitted]);

  useEffect(() => {
    // Leaflet 라이브러리 로드 및 초기화
    let isMounted = true;
    const L = (window as any).L;
    
    // 이미 Leaflet이 로드되어 있고, 엘리먼트가 준비되었는지 확인
    if (!L || !mapElementRef.current) return;
    
    const el = mapElementRef.current;
    
    // 기존 지도 인스턴스 제거 (클린업 로직 대체)
    if (mapInstanceRef.current) {
        mapInstanceRef.current.remove();
        mapInstanceRef.current = null;
    }

    try {
        // Leaflet Icon 경로 설정 (404 오류 방지)
        L.Icon.Default.mergeOptions({
            iconRetinaUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon-2x.png',
            iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',
            shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png'
        });

        // 지도 초기화 (el 사용)
        const map = L.map(el, { 
            zoomControl: false, 
            scrollWheelZoom: false 
        }).setView([35.104, 128.966], 14);
        
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            attribution: '&copy; OpenStreetMap contributors',
        }).addTo(map);
        
        L.marker([35.104, 128.966]).addTo(map).bindPopup("하단역").openPopup();

        mapInstanceRef.current = map;

        
        // ⭐️ 2. ResizeObserver를 사용하여 컨테이너 크기 변화 감지 (최적의 해결책)
        // 지도가 초기화될 때와 컨테이너 크기가 변할 때마다 invalidateSize 호출
        const observer = new ResizeObserver(() => {
            if (mapInstanceRef.current) {
                mapInstanceRef.current.invalidateSize(true);
            }
        });

        observer.observe(el);

        
        // 3. 컴포넌트 언마운트 시 클린업
        return () => {
            isMounted = false;
            observer.unobserve(el); // 옵저버 해제
            if (mapInstanceRef.current) {
                mapInstanceRef.current.remove();
                mapInstanceRef.current = null;
            }
        };

    } catch (err) {
      if (isMounted) console.error("Leaflet init failed:", err);
    }
    
    return () => {}; // 클린업 함수 반환
  }, [mapElementRef.current]); 
  // 의존성 배열에 mapElementRef.current를 넣어 DOM 엘리먼트가 마운트/변경될 때만 실행되도록 보장

  // Leaflet 라이브러리 스크립트를 한 번만 동적으로 로드 (이미 제공된 코드의 방식)
  useEffect(() => {
    if ((window as any).L) return; // 이미 로드되어 있다면 실행하지 않음
    
    const script = document.createElement("script");
    script.src = "https://unpkg.com/leaflet@1.9.4/dist/leaflet.js";
    script.async = true;
    document.body.appendChild(script);

    return () => {
        script.remove();
    }
  }, []);


  return (
    <div className="min-h-screen text-[#e8eaed] bg-[#202124] overflow-y-scroll no-scrollbar">
      <header className="w-full border-b border-white/10 sticky top-0 z-40 bg-[#202124]/80 backdrop-blur">
        <div className="max-w-7xl mx-auto px-4 py-3 flex items-center gap-4">
          <div className="text-2xl font-bold tracking-tight">Goo<span className="text-[#8ab4f8]">gle</span></div>
          <form
            className="flex-1"
            onSubmit={(e) => {
              e.preventDefault();
              setSubmitted(q);
            }}
          >
            <div className="flex items-center gap-2 bg-[#303134] rounded-full pl-4 pr-2 py-2 border border-transparent focus-within:border-white/20 shadow">
              <span className="text-[#bdc1c6] text-sm">🔎</span>
              <input
                value={q}
                onChange={(e) => setQ(e.target.value)}
                placeholder="검색 또는 URL 입력"
                className="flex-1 bg-transparent outline-none placeholder:text-[#9aa0a6] text-sm"
                data-testid="search-input"
              />
              <button
                type="submit"
                className="px-4 py-1.5 bg-[#8ab4f8] text-[#202124] rounded-full text-sm font-semibold hover:brightness-95"
                data-testid="search-submit"
              >
                Google 검색
              </button>
            </div>
          </form>
        </div>
      </header>

      <main className="max-w-7xl mx-auto px-4 pt-6 grid grid-cols-1 lg:grid-cols-[minmax(0,1fr)_360px] gap-8">
        <section className="col-span-full">
          <div className="mb-3">
            <h1 className="text-2xl md:text-[28px] font-semibold tracking-tight text-[#e8eaed]">글로컬크리에어터 중단팀</h1>
            <div className="text-sm text-[#9aa0a6] mt-1">부산광역시 금정구 금샘로 485번길 65</div>
          </div>

          <div className="grid lg:grid-cols-[minmax(0,1fr)_360px] gap-4">
            <div className="relative rounded-2xl overflow-hidden border border-white/10 bg-[#303134]">
              <img referrerPolicy="no-referrer" src="https://postfiles.pstatic.net/MjAyNTExMTFfMTY1/MDAxNzYyODM0NjE3MTc1.1ap22VNgJtNmgu-dEu9jssTbYQo87gikRbcGLhYSCiUg.XiJpPPisKcO0rTuG5fN44BaDJlb07OrNTAibATpFZtkg.PNG/Gemini_Generated_Image_px7fb9px7fb9px7f.png?type=w580" alt="자갈치시장 (부산)" className="w-full h-[260px] md:h-[360px] object-cover" />
              <div className="absolute bottom-3 right-3 flex gap-2">
                <button className="w-8 h-8 grid place-items-center rounded-full bg-black/60 text-white text-sm">‹</button>
                <button className="w-8 h-8 grid place-items-center rounded-full bg-black/60 text-white text-sm">›</button>
              </div>
            </div>

            <div className="grid gap-4">
              <div className="rounded-2xl border border-white/10 bg-[#1f2023] h-[180px] relative overflow-hidden">
                {/* ⭐️ mapElementRef를 사용하여 DOM 엘리먼트 참조 */}
                <div ref={mapElementRef} id="mapPreview" className="absolute inset-0" />
              </div>

              <div className="grid grid-cols-2 gap-4">
                <div className="rounded-2xl border border-white/10 bg-[#303134] p-4">
                  <div className="text-sm text-[#9aa0a6] mb-2">날씨</div>
                  <div className="flex items-center justify-between">
                    <div className="text-center"><div className="text-xs text-[#9aa0a6]">화</div><div className="text-base">☀️ 17°</div></div>
                    <div className="text-center"><div className="text-xs text-[#9aa0a6]">수</div><div className="text-base">☀️ 19°</div></div>
                    <div className="text-center"><div className="text-xs text-[#9aa0a6]">목</div><div className="text-base">☀️ 19°</div></div>
                  </div>
                  <a className="mt-2 inline-block text-xs text-[#8ab4f8] hover:underline" href="#">웨더뉴스</a>
                </div>
                <div className="rounded-2xl border border-white/10 bg-[#303134] overflow-hidden">
                  <img
                    src="https://www.busan.com/nas/data/content/image/2015/02/16/20150216000102_0.jpg"
                    alt="부산광역시 전경"
                    className="w-full h-full object-cover"
                  />
                </div>
              </div>
            </div>
          </div>

          <div className="grid lg:grid-cols-2 gap-4 mt-4">
            <div className="rounded-2xl border border-white/10 bg-[#303134] p-4 text-[#bdc1c6] leading-relaxed">
              <div className="text-[#e8eaed] font-semibold mb-2">기본현황</div>
              부산 하단동이 단순히 경유지가 아닌, 외국인 관광객이 '머물고, 소비하고 싶은' 목적지가 되기 위한 글로컬 크리에이터의 핵심 전략은 하단이 가진 독특한 자원을 '환승 시간'에 맞춘 매력적인 체험으로 바꾸는 것입니다.
            </div>
            <div className="rounded-2xl border border-white/10 bg-[#303134] p-4 text-sm text-[#e8eaed]">
              <div className="text-[#e8eaed] font-semibold mb-2">하단 지역 핵심지표</div>
              <dl className="grid grid-cols-[120px_minmax(0,1fr)] gap-y-2">
                <dt className="text-[#9aa0a6]">주요 자원</dt><dd>을숙도, 동아대, 낙동강하구둑 (3大 랜드마크)</dd>
                <dt className="text-[#9aa0a6]">콘텐츠 접근성</dt><dd>부산 유일의 '강-바다' 접점 더블 역세권</dd>
                <dt className="text-[#9aa0a6]">잠재력</dt><dd>글로벌 로컬 콘텐츠 테스트베드(Testbed)</dd>
              </dl>
            </div>
          </div>
        </section>

        <section>
          <p className="text-sm text-[#9aa0a6] mb-3">약 {results.length.toLocaleString()}개 결과</p>
          <ul className="space-y-6">
            {/* ⭐️ 검색 결과 렌더링 복구 */}
            {results.map((r, i) => (
              <li key={i} className="group border-b border-white/10 pb-4">
                <div className="text-xs text-[#9aa0a6] mb-1">{r.displayUrl}</div>
                <a href={r.url} target="_blank" rel="noreferrer" className="block">
                  <div className="text-lg md:text-xl leading-snug text-[#8ab4f8] group-hover:underline">{r.title}</div>
                </a>
                <div className="mt-1 flex items-center gap-2 text-sm text-[#e8eaed]">
                  <span className="font-semibold text-[#fbbc04]">★ {r.rating}</span>
                  <span className="text-[#9aa0a6]">({r.reviews.toLocaleString()}건의 리뷰)</span>
                </div>
                <div className="mt-1 text-[#bdc1c6] leading-relaxed">{r.snippet}</div>
              </li>
            ))}
          </ul>
        </section>

        <aside className="hidden lg:block lg:sticky lg:top-[76px] h-fit">
          <div className="rounded-2xl border border-white/10 bg-[#303134] overflow-hidden shadow">
            <a href="https://commons.wikimedia.org/wiki/File:Camellia_japonica_NBG.jpg" target="_blank" rel="noreferrer" className="block">
              <img referrerPolicy="no-referrer" src="https://postfiles.pstatic.net/MjAyNTExMTFfMzkg/MDAxNzYyODMzNTk1MTA1.Tgw94vuCud01GqJEllygmWJLI0DOuYCypY3EMvDfAckg.NjUIog0XiqSfIw0Ay0nEHSIolK5emHr9L4zjt6PtMaMg.PNG/rmfzm.png?type=w580" alt="글로컬 크리에이터" className="w-full aspect-square object-cover" />
            </a>
            <div className="p-4">
              <div className="text-sm text-[#9aa0a6] mb-1">이름</div>
              <div className="text-base text-[#e8eaed] font-semibold">글로컬 크리에이터</div>
              <a href="https://commons.wikimedia.org/wiki/File:Camellia_japonica_NBG.jpg" target="_blank" rel="noreferrer" className="mt-2 inline-block text-[#8ab4f8] text-sm hover:underline">부산외국어대학교 : 박광우 교수</a>
            </div>
          </div>
        </aside>
      </main>

      <footer className="max-w-7xl mx-auto px-4 mt-10 py-6 text-xs text-[#9aa0a6] border-t border-white/10">
        <div className="flex flex-wrap items-center gap-4">
          <span>대한민국 · 부산 · 하단</span>
          <span className="text-[#5f6368]">·</span>
          <span>이 미리보기는 학습·시연용 UI 클론입니다.</span>
        </div>
      </footer>
    </div>
  );
}

const style = document.createElement('style');
style.innerHTML = `
  /* Leaflet CSS for Map Preview */
  @import url('https://unpkg.com/leaflet@1.9.4/dist/leaflet.css');
  
  .no-scrollbar::-webkit-scrollbar { display: none; }
  .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
  
  /* Leaflet Map 컨테이너 배경색 설정 */
  .leaflet-container {
      background-color: #ccc; 
  }
`;
document.head.appendChild(style);

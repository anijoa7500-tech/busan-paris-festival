<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // GitHub Pages 경로에 맞춰 수정한 seedResults 배열은 그대로 유지합니다.
    const seedResults = [
        {
            title: "[부산한정] NFC 비누비누 베이베 키링 · GLOCAL:HD",
            url: "/busan-paris-festival/product-page.html", 
            displayUrl: "glocal-hd.com/product/...r",
            snippet: "사하구 하단 문화의거리에서 열리는 프렌치 마르쉐 & 공연 축제입니다. 부산외국어대학교 글로컬 크리에이터 하단 팀이 함께하는 프로젝트로, 일정·프로그램·티켓·지도 정보를 한눈에 확인할 수 있습니다.",
            rating: 4.9,
            reviews: 1482,
        },
        {
            title: "하단 숙박/체험 로컬 여행 상품 리스트 · 하단.음숙.다.대.허브",
            url: "/busan-paris-festival/tour-list.html",
            displayUrl: "hadan.umsuk.daedae.heobeo",
            snippet: "부산 사하구 하단 문화의거리 기반의 로컬 여행 상품 추천 목록입니다. K-인싸 투어, 1일 비누 만들기, 로컬 맛집 등 다양한 테마별 액티비티와 숙박 정보를 제공합니다.",
            rating: 4.6,
            reviews: 524,
        },
        {
            title: "부산 파리 마르쉐 · 공식 안내(일정·오시는 길)",
            url: "/busan-paris-festival/paris-festival.html",
            displayUrl: "busan-parisfest.kr",
            snippet: "사하구 하단 문화의거리에서 열리는 프렌치 마르쉐 & 공연 축제입니다. 프랑스의 마르쉐와 카페 문화를 옮겨온 도시형 축제로, 디저트/치즈, 공연, 포토스팟을 즐길 수 있습니다. (일정: 2025. 12. 6(토) - 12. 7(일))",
            rating: 4.7,
            reviews: 861,
        },
        {
            title: "하단 재즈 나잇 · 공연 라인업 및 타임테이블",
            url: "https://hadanjazz.kr/lineup",
            displayUrl: "hadanjazz.kr",
            snippet: "하단역 일대에서 열리는 도심형 재즈 축제입니다. 국내외 재즈 아티스트, 게스트 세션 정보와 공연 시간표를 미리 만나보세요.",
            rating: 4.8,
            reviews: 1023,
        },
        {
            title: "다대포 선셋 포토워크 · 참가자 모집(하단 출발)",
            url: "https://www.dadaepo-sunset.com/walk",
            displayUrl: "dadaepo-sunset.com",
            snippet: "하단에서 출발해 다대포 해변 일몰 명소를 걷는 포토워크입니다. 촬영 포인트, 복장 가이드, 날씨 체크리스트를 참고해보세요.",
            rating: 4.5,
            reviews: 392,
        },
        {
            title: "로컬 베이커리 위크 in 하단 · 참가 매장 안내",
            url: "https://bakeryweek.kr/hadan",
            displayUrl: "bakeryweek.kr",
            snippet: "하단의 개성 있는 로컬 베이커리 20여 곳이 참여합니다. 시그니처 메뉴, 빵 굽는 시간, 스탬프 위치와 한정 굿즈 정보를 제공합니다.",
            rating: 4.6,
            reviews: 745,
        },
    ];

    function renderResults(results) {
        const list = document.getElementById('resultsList');
        if (!list) return;
        
        list.innerHTML = results.map(r => `
            <li class="group border-b border-white/10 pb-4">
                <div class="text-xs text-[#9aa0a6] mb-1">${r.displayUrl}</div>
                <a href="${r.url}" target="${r.url.startsWith('http') ? '_blank' : '_self'}" rel="noreferrer" class="block">
                    <div class="text-lg md:text-xl leading-snug text-google-blue group-hover:underline">${r.title}</div>
                </a>
                <div class="mt-1 flex items-center gap-2 text-sm text-[#e8eaed]">
                    <span class="font-semibold text-google-yellow">★ ${r.rating}</span>
                    <span class="text-[#9aa0a6]">(${r.reviews.toLocaleString()}건의 리뷰)</span>
                </div>
                <div class="mt-1 text-[#bdc1c6] leading-relaxed">${r.snippet}</div>
            </li>
        `).join('');
    }

    // Leaflet Map Initialization
    let mapInstance = null;
    function initializeMap() {
        const L = window.L;
        const el = document.getElementById("mapPreview");
        
        if (!L || !el) {
            setTimeout(initializeMap, 100); 
            return;
        }

        try {
            if (mapInstance) {
                mapInstance.remove();
                mapInstance = null;
            }

            mapInstance = L.map(el, { zoomControl: false }).setView([35.104, 128.966], 14);
            L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
                attribution: '&copy; OpenStreetMap contributors',
            }).addTo(mapInstance);
            L.marker([35.104, 128.966]).addTo(mapInstance).bindPopup("하단역").openPopup();

            // 3. 지도 크기 오류 해결: requestAnimationFrame을 사용하여 다음 렌더링 프레임에서 크기를 업데이트합니다.
            // 이 방식이 특정 상황에서 setTimeout보다 더 안정적으로 크기를 잡습니다.
            requestAnimationFrame(() => {
                 mapInstance.invalidateSize();
            }); 

        } catch (err) {
            console.error("Leaflet map initialization failed:", err);
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        renderResults(seedResults);
        initializeMap();
    });

    // 윈도우 로드 후에도 지도를 다시 초기화/크기 조정 시도
    window.addEventListener('load', initializeMap);
</script>

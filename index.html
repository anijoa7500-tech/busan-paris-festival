import React, { useMemo, useState, useEffect } from "react";

// ... (seedResults ìƒëµ) ...
const seedResults = [
  {
    title: "[ë¶€ì‚°í•œì •] NFC ë¹„ëˆ„ë¹„ëˆ„ ë² ì´ë²  í‚¤ë§ Â· GLOCAL:HD",
    url: "https://glocal-hd.com/product/...",
    displayUrl: "glocal-hd.com/product/...r",
    snippet:
      "ì‚¬í•˜êµ¬ í•˜ë‹¨ ë¬¸í™”ì˜ê±°ë¦¬ì—ì„œ ì—´ë¦¬ëŠ” í”„ë Œì¹˜ ë§ˆë¥´ì‰ & ê³µì—° ì¶•ì œì…ë‹ˆë‹¤. ë¶€ì‚°ì™¸êµ­ì–´ëŒ€í•™êµ ê¸€ë¡œì»¬ í¬ë¦¬ì—ì´í„° í•˜ë‹¨ íŒ€ì´ í•¨ê»˜í•˜ëŠ” í”„ë¡œì íŠ¸ë¡œ, ì¼ì •Â·í”„ë¡œê·¸ë¨Â·í‹°ì¼“Â·ì§€ë„ ì •ë³´ë¥¼ í•œëˆˆì— í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.",
    rating: 4.9,
    reviews: 1482,
  },
  {
    title: "í•˜ë‹¨ ìˆ™ë°•/ì²´í—˜ ë¡œì»¬ ì—¬í–‰ ìƒí’ˆ ë¦¬ìŠ¤íŠ¸ Â· í•˜ë‹¨.ìŒìˆ™.ë‹¤.ëŒ€.í—ˆë¸Œ",
    url: "https://hadan-travelhub.co.kr",
    displayUrl: "hadan.umsuk.daedae.heobeo",
    snippet:
      "ë¶€ì‚° ì‚¬í•˜êµ¬ í•˜ë‹¨ ë¬¸í™”ì˜ê±°ë¦¬ ê¸°ë°˜ì˜ ë¡œì»¬ ì—¬í–‰ ìƒí’ˆ ì¶”ì²œ ëª©ë¡ì…ë‹ˆë‹¤. K-ì¸ì‹¸ íˆ¬ì–´, 1ì¼ ë¹„ëˆ„ ë§Œë“¤ê¸°, ë¡œì»¬ ë§›ì§‘ ë“± ë‹¤ì–‘í•œ í…Œë§ˆë³„ ì•¡í‹°ë¹„í‹°ì™€ ìˆ™ë°• ì •ë³´ë¥¼ ì œê³µí•©ë‹ˆë‹¤.",
    rating: 4.6,
    reviews: 524,
  },
  {
    title: "ë¶€ì‚° íŒŒë¦¬ ë§ˆë¥´ì‰ Â· ê³µì‹ ì•ˆë‚´(ì¼ì •Â·ì˜¤ì‹œëŠ” ê¸¸)",
    url: "https://busan-parisfest.kr",
    displayUrl: "busan-parisfest.kr",
    snippet:
      "ì‚¬í•˜êµ¬ í•˜ë‹¨ ë¬¸í™”ì˜ê±°ë¦¬ì—ì„œ ì—´ë¦¬ëŠ” í”„ë Œì¹˜ ë§ˆë¥´ì‰ & ê³µì—° ì¶•ì œì…ë‹ˆë‹¤. í”„ë‘ìŠ¤ì˜ ë§ˆë¥´ì‰ì™€ ì¹´í˜ ë¬¸í™”ë¥¼ ì˜®ê²¨ì˜¨ ë„ì‹œí˜• ì¶•ì œë¡œ, ë””ì €íŠ¸/ì¹˜ì¦ˆ, ê³µì—°, í¬í† ìŠ¤íŒŸì„ ì¦ê¸¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤. (ì¼ì •: 2025. 12. 6(í† ) - 12. 7(ì¼))",
    rating: 4.7,
    reviews: 861,
  },
  {
    title: "í•˜ë‹¨ ì¬ì¦ˆ ë‚˜ì‡ Â· ê³µì—° ë¼ì¸ì—… ë° íƒ€ì„í…Œì´ë¸”",
    url: "https://hadanjazz.kr/lineup",
    displayUrl: "hadanjazz.kr",
    snippet:
      "í•˜ë‹¨ì—­ ì¼ëŒ€ì—ì„œ ì—´ë¦¬ëŠ” ë„ì‹¬í˜• ì¬ì¦ˆ ì¶•ì œì…ë‹ˆë‹¤. êµ­ë‚´ì™¸ ì¬ì¦ˆ ì•„í‹°ìŠ¤íŠ¸, ê²ŒìŠ¤íŠ¸ ì„¸ì…˜ ì •ë³´ì™€ ê³µì—° ì‹œê°„í‘œë¥¼ ë¯¸ë¦¬ ë§Œë‚˜ë³´ì„¸ìš”.",
    rating: 4.8,
    reviews: 1023,
  },
  {
    title: "ë‹¤ëŒ€í¬ ì„ ì…‹ í¬í† ì›Œí¬ Â· ì°¸ê°€ì ëª¨ì§‘(í•˜ë‹¨ ì¶œë°œ)",
    url: "https://www.dadaepo-sunset.com/walk",
    displayUrl: "dadaepo-sunset.com",
    snippet:
      "í•˜ë‹¨ì—ì„œ ì¶œë°œí•´ ë‹¤ëŒ€í¬ í•´ë³€ ì¼ëª° ëª…ì†Œë¥¼ ê±·ëŠ” í¬í† ì›Œí¬ì…ë‹ˆë‹¤. ì´¬ì˜ í¬ì¸íŠ¸, ë³µì¥ ê°€ì´ë“œ, ë‚ ì”¨ ì²´í¬ë¦¬ìŠ¤íŠ¸ë¥¼ ì°¸ê³ í•´ë³´ì„¸ìš”.",
    rating: 4.5,
    reviews: 392,
  },
  {
    title: "ë¡œì»¬ ë² ì´ì»¤ë¦¬ ìœ„í¬ in í•˜ë‹¨ Â· ì°¸ê°€ ë§¤ì¥ ì•ˆë‚´",
    url: "https://bakeryweek.kr/hadan",
    displayUrl: "bakeryweek.kr",
    snippet:
      "í•˜ë‹¨ì˜ ê°œì„± ìˆëŠ” ë¡œì»¬ ë² ì´ì»¤ë¦¬ 20ì—¬ ê³³ì´ ì°¸ì—¬í•©ë‹ˆë‹¤. ì‹œê·¸ë‹ˆì²˜ ë©”ë‰´, ë¹µ êµ½ëŠ” ì‹œê°„, ìŠ¤íƒ¬í”„ ìœ„ì¹˜ì™€ í•œì • êµ¿ì¦ˆ ì •ë³´ë¥¼ ì œê³µí•©ë‹ˆë‹¤.",
    rating: 4.6,
    reviews: 745,
  },
];


export default function GoogleStyleSearchPreview() {
  const [q, setQ] = useState("ë¶€ì‚°ì™¸êµ­ì–´ëŒ€í•™êµ ê¸€ë¡œì»¬í¬ë¦¬ì—ì´í„° í•˜ë‹¨");
  const [submitted, setSubmitted] = useState("ë¶€ì‚°ì™¸êµ­ì–´ëŒ€í•™êµ ê¸€ë¡œì»¬í¬ë¦¬ì—ì´í„° í•˜ë‹¨");

  const results = useMemo(() => {
    if (!submitted) return seedResults;
    const k = submitted.trim().toLowerCase();
    const tokens = k.split(' ').filter(Boolean);
    const filtered = seedResults.filter((r) => {
      if (tokens.length === 0) return true;
      const title = r.title.toLowerCase();
      const snip = r.snippet.toLowerCase();
      return tokens.some((t) => title.includes(t) || snip.includes(t));
    });
    return filtered.length ? filtered : seedResults;
  }, [submitted]);

  useEffect(() => {
    // 1. CSS ë° Script ë™ì  ë¡œë“œ (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
    const css = document.createElement("link");
    css.rel = "stylesheet";
    css.href = "https://unpkg.com/leaflet@1.9.4/dist/leaflet.css";
    document.head.appendChild(css);

    const script = document.createElement("script");
    script.src = "https://unpkg.com/leaflet@1.9.4/dist/leaflet.js";
    script.async = true;
    document.body.appendChild(script);

    let mapInstance = null;
    
    script.onload = () => {
      try {
        const L = (window as any).L;
        if (!L) return;
        const el = document.getElementById("mapPreview");
        if (!el) return;

        // 2. Leaflet Icon ê²½ë¡œ ì„¤ì • (404 ì˜¤ë¥˜ ë°©ì§€)
        L.Icon.Default.mergeOptions({
            iconRetinaUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon-2x.png',
            iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',
            shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png'
        });

        // 3. ì§€ë„ ì´ˆê¸°í™”
        mapInstance = L.map(el, { zoomControl: false, scrollWheelZoom: false }).setView([35.104, 128.966], 14);
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          attribution: '&copy; OpenStreetMap contributors',
        }).addTo(mapInstance);
        L.marker([35.104, 128.966]).addTo(mapInstance).bindPopup("í•˜ë‹¨ì—­").openPopup();

        // 4. â­ í•µì‹¬ ìˆ˜ì •: ë Œë”ë§ í›„ í¬ê¸° ì¬ê³„ì‚° ê°•ì œ í˜¸ì¶œ
        // Leafletì´ Grid ë ˆì´ì•„ì›ƒ ë‚´ì—ì„œ ì˜¬ë°”ë¥¸ ì§ì‚¬ê°í˜• í¬ê¸°ë¥¼ ì¸ì‹í•˜ë„ë¡ ë•ìŠµë‹ˆë‹¤.
        setTimeout(() => {
            if (mapInstance) {
                mapInstance.invalidateSize(true);
            }
        }, 100); 

      } catch (err) {
        console.error("Leaflet init failed:", err);
      }
    };

    // 5. í´ë¦°ì—… ë¡œì§
    return () => {
      const el = document.getElementById("mapPreview");
      if (el) el.replaceChildren();

      // ì§€ë„ ì¸ìŠ¤í„´ìŠ¤ê°€ ìˆë‹¤ë©´ ì œê±°
      if (mapInstance) {
        mapInstance.remove();
        mapInstance = null;
      }
      
      // ë¡œë“œëœ ìŠ¤í¬ë¦½íŠ¸ì™€ CSSë„ ì œê±° (ì„ íƒ ì‚¬í•­ì´ì§€ë§Œ ê¹”ë”í•¨)
      css.remove();
      script.remove();
    };
  }, []); // ì˜ì¡´ì„± ë°°ì—´ì´ ë¹„ì–´ìˆìœ¼ë¯€ë¡œ ì»´í¬ë„ŒíŠ¸ ë§ˆìš´íŠ¸ ì‹œ í•œ ë²ˆë§Œ ì‹¤í–‰

  return (
    <div className="min-h-screen text-[#e8eaed] bg-[#202124] overflow-y-scroll no-scrollbar">
      <header className="w-full border-b border-white/10 sticky top-0 z-40 bg-[#202124]/80 backdrop-blur">
        <div className="max-w-7xl mx-auto px-4 py-3 flex items-center gap-4">
          <div className="text-2xl font-bold tracking-tight">Goo<span className="text-[#8ab4f8]">gle</span></div>
          <form
            className="flex-1"
            onSubmit={(e) => {
              e.preventDefault();
              setSubmitted(q);
            }}
          >
            <div className="flex items-center gap-2 bg-[#303134] rounded-full pl-4 pr-2 py-2 border border-transparent focus-within:border-white/20 shadow">
              <span className="text-[#bdc1c6] text-sm">ğŸ”</span>
              <input
                value={q}
                onChange={(e) => setQ(e.target.value)}
                placeholder="ê²€ìƒ‰ ë˜ëŠ” URL ì…ë ¥"
                className="flex-1 bg-transparent outline-none placeholder:text-[#9aa0a6] text-sm"
                data-testid="search-input"
              />
              <button
                type="submit"
                className="px-4 py-1.5 bg-[#8ab4f8] text-[#202124] rounded-full text-sm font-semibold hover:brightness-95"
                data-testid="search-submit"
              >
                Google ê²€ìƒ‰
              </button>
            </div>
          </form>
        </div>
      </header>

      <main className="max-w-7xl mx-auto px-4 pt-6 grid grid-cols-1 lg:grid-cols-[minmax(0,1fr)_360px] gap-8">
        <section className="col-span-full">
          <div className="mb-3">
            <h1 className="text-2xl md:text-[28px] font-semibold tracking-tight text-[#e8eaed]">ê¸€ë¡œì»¬í¬ë¦¬ì—ì–´í„° ì¤‘ë‹¨íŒ€</h1>
            <div className="text-sm text-[#9aa0a6] mt-1">ë¶€ì‚°ê´‘ì—­ì‹œ ê¸ˆì •êµ¬ ê¸ˆìƒ˜ë¡œ 485ë²ˆê¸¸ 65</div>
          </div>

          <div className="grid lg:grid-cols-[minmax(0,1fr)_360px] gap-4">
            <div className="relative rounded-2xl overflow-hidden border border-white/10 bg-[#303134]">
              <img referrerPolicy="no-referrer" src="https://postfiles.pstatic.net/MjAyNTExMTFfMTY1/MDAxNzYyODM0NjE3MTc1.1ap22VNgJtNmgu-dEu9jssTbYQo87gikRbcGLhYSCiUg.XiJpPPisKcO0rTuG5fN44BaDJlb07OrNTAibATpFZtkg.PNG/Gemini_Generated_Image_px7fb9px7fb9px7f.png?type=w580" alt="ìê°ˆì¹˜ì‹œì¥ (ë¶€ì‚°)" className="w-full h-[260px] md:h-[360px] object-cover" />
              <div className="absolute bottom-3 right-3 flex gap-2">
                <button className="w-8 h-8 grid place-items-center rounded-full bg-black/60 text-white text-sm">â€¹</button>
                <button className="w-8 h-8 grid place-items-center rounded-full bg-black/60 text-white text-sm">â€º</button>
              </div>
            </div>

            <div className="grid gap-4">
              <div className="rounded-2xl border border-white/10 bg-[#1f2023] h-[180px] relative overflow-hidden">
                {/* ì§€ë„ ì»¨í…Œì´ë„ˆ */}
                <div id="mapPreview" className="absolute inset-0" />
              </div>

              <div className="grid grid-cols-2 gap-4">
                <div className="rounded-2xl border border-white/10 bg-[#303134] p-4">
                  <div className="text-sm text-[#9aa0a6] mb-2">ë‚ ì”¨</div>
                  <div className="flex items-center justify-between">
                    <div className="text-center"><div className="text-xs text-[#9aa0a6]">í™”</div><div className="text-base">â˜€ï¸ 17Â°</div></div>
                    <div className="text-center"><div className="text-xs text-[#9aa0a6]">ìˆ˜</div><div className="text-base">â˜€ï¸ 19Â°</div></div>
                    <div className="text-center"><div className="text-xs text-[#9aa0a6]">ëª©</div><div className="text-base">â˜€ï¸ 19Â°</div></div>
                  </div>
                  <a className="mt-2 inline-block text-xs text-[#8ab4f8] hover:underline" href="#">ì›¨ë”ë‰´ìŠ¤</a>
                </div>
                <div className="rounded-2xl border border-white/10 bg-[#303134] overflow-hidden">
                  <img
                    src="https://www.busan.com/nas/data/content/image/2015/02/16/20150216000102_0.jpg"
                    alt="ë¶€ì‚°ê´‘ì—­ì‹œ ì „ê²½"
                    className="w-full h-full object-cover"
                  />
                </div>
              </div>
            </div>
          </div>
          {/* ... (ê¸°ë³¸í˜„í™©, í•µì‹¬ì§€í‘œ ì„¹ì…˜ ìƒëµ) ... */}
        </section>

        <section>
          <p className="text-sm text-[#9aa0a6] mb-3">ì•½ {results.length.toLocaleString()}ê°œ ê²°ê³¼</p>
          <ul className="space-y-6">
            {results.map((r, i) => (
              <li key={i} className="group border-b border-white/10 pb-4">
                <div className="text-xs text-[#9aa0a6] mb-1">{r.displayUrl}</div>
                <a href={r.url} target="_blank" rel="noreferrer" className="block">
                  <div className="text-lg md:text-xl leading-snug text-[#8ab4f8] group-hover:underline">{r.title}</div>
                </a>
                <div className="mt-1 flex items-center gap-2 text-sm text-[#e8eaed]">
                  <span className="font-semibold">â˜… {r.rating}</span>
                  <span className="text-[#9aa0a6]">({r.reviews.toLocaleString()}ê±´ì˜ ë¦¬ë·°)</span>
                </div>
                <div className="mt-1 text-[#bdc1c6] leading-relaxed">{r.snippet}</div>
              </li>
            ))}
          </ul>
        </section>

        {/* ... (aside/Knowledge Panel ì„¹ì…˜ ìƒëµ) ... */}
      </main>

      <footer className="max-w-7xl mx-auto px-4 mt-10 py-6 text-xs text-[#9aa0a6] border-t border-white/10">
        <div className="flex flex-wrap items-center gap-4">
          <span>ëŒ€í•œë¯¼êµ­ Â· ë¶€ì‚° Â· í•˜ë‹¨</span>
          <span className="text-[#5f6368]">Â·</span>
          <span>ì´ ë¯¸ë¦¬ë³´ê¸°ëŠ” í•™ìŠµÂ·ì‹œì—°ìš© UI í´ë¡ ì…ë‹ˆë‹¤.</span>
        </div>
      </footer>
    </div>
  );
}

const style = document.createElement('style');
style.innerHTML = `
  .no-scrollbar::-webkit-scrollbar { display: none; }
  .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
`;
document.head.appendChild(style);
